
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ngọc Lan - POS Smart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary-blue: #2563eb; }
        body { font-family: -apple-system, system-ui, sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); color: #1f2937; margin: 0; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(186, 230, 253, 0.5); box-shadow: 0 8px 20px -5px rgba(37, 99, 235, 0.1); }
        .btn-blue { background: linear-gradient(to right, #3b82f6, #2563eb); }
        .btn-blue:active { transform: scale(0.96); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-up { animation: slideUp 0.4s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const Icons = {
            Plus: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>,
            Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Search: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        };

        function App() {
            const [items, setItems] = useState([]);
            const [customer, setCustomer] = useState('Khách lẻ');
            const [customerNote, setCustomerNote] = useState('');
            const [form, setForm] = useState({ name: '', qty: 1, price: '', promo: '' });
            
            // Dữ liệu từ Google Sheets
            const [sheetUrl, setSheetUrl] = useState(localStorage.getItem('POS_SHEET_NL') || '');
            const [dbProducts, setDbProducts] = useState([]);
            const [dbCustomers, setDbCustomers] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            
            const [showSettings, setShowSettings] = useState(false);
            const [showProductPicker, setShowProductPicker] = useState(false);
            const [showCustomerPicker, setShowCustomerPicker] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [notif, setNotif] = useState(null);
            const receiptRef = useRef(null);

            const showNotif = (msg) => { setNotif(msg); setTimeout(() => setNotif(null), 3000); }

            // Fetch dữ liệu khi khởi động hoặc đổi URL
            useEffect(() => {
                if (sheetUrl) fetchData();
            }, [sheetUrl]);

            const fetchData = async () => {
                setIsLoading(true);
                try {
                    // Giả sử script App Script trả về JSON chứa cả 2 mảng
                    const res = await fetch(sheetUrl + "?action=getData");
                    const data = await res.json();
                    setDbProducts(data.products || []);
                    setDbCustomers(data.customers || []);
                    showNotif("✅ Đồng bộ dữ liệu thành công");
                } catch (e) {
                    console.error("Lỗi fetch:", e);
                    // Dữ liệu mẫu nếu lỗi
                    setDbProducts([
                        { name: "Phân bón NPK", price: 150000 },
                        { name: "Thuốc trừ sâu A", price: 85000 },
                        { name: "Hạt giống Hoa", price: 25000 }
                    ]);
                    setDbCustomers([
                        { name: "Anh Minh (Đức Linh)", note: "090xxxxxxx" },
                        { name: "Chị Lan (Phan Thiết)", note: "091xxxxxxx" }
                    ]);
                } finally {
                    setIsLoading(false);
                }
            };

            const addItem = () => {
                if (!form.name || !form.price) return;
                let finalPrice = Number(form.price);
                let discountText = "";
                if (form.promo.includes('%')) {
                    const match = form.promo.match(/(\d+)%/);
                    if (match) {
                        const pct = parseFloat(match[1]);
                        finalPrice = finalPrice * (1 - pct / 100);
                        discountText = `(Giảm ${pct}%)`;
                    }
                }
                setItems([{ id: Date.now(), ...form, price: finalPrice, originalPrice: Number(form.price), discountText }, ...items]);
                setForm({ name: '', qty: 1, price: '', promo: '' });
                if (window.navigator.vibrate) window.navigator.vibrate(30);
            };

            const total = items.reduce((s, i) => s + (i.price * i.qty), 0);

            const filteredProducts = useMemo(() => 
                dbProducts.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase())),
            [dbProducts, searchTerm]);

            const filteredCustomers = useMemo(() => 
                dbCustomers.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase())),
            [dbCustomers, searchTerm]);

            const selectProduct = (p) => {
                setForm({ ...form, name: p.name, price: p.price });
                setShowProductPicker(false);
                setSearchTerm('');
            };

            const selectCustomer = (c) => {
                setCustomer(c.name);
                setCustomerNote(c.note || '');
                setShowCustomerPicker(false);
                setSearchTerm('');
            };

            const handleDownload = async () => {
                if (items.length === 0) return;
                showNotif("Đang tạo ảnh...");
                const canvas = await html2canvas(receiptRef.current, { scale: 2 });
                const link = document.createElement('a');
                link.download = `DonHang_${customer}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showNotif("✅ Đã tải ảnh");
            };

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto overflow-hidden relative bg-blue-50/30">
                    {notif && <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[200] bg-blue-600 text-white text-[11px] font-bold px-6 py-2 rounded-full shadow-xl">{notif}</div>}
                    
                    {/* Header */}
                    <div className="pt-12 bg-gradient-to-br from-blue-600 to-blue-800 text-white px-6 pb-6 rounded-b-[2.5rem] shadow-lg flex justify-between items-end">
                        <div>
                            <h1 className="text-xl font-black italic tracking-tighter">NGỌC LAN</h1>
                            <p className="text-[10px] font-bold opacity-60">QUẢN LÝ ĐƠN HÀNG</p>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="p-3 bg-white/20 rounded-2xl"><Icons.Settings /></button>
                    </div>

                    <div className="flex-1 overflow-y-auto px-5 py-6 space-y-4 no-scrollbar">
                        {/* Khách hàng */}
                        <div className="glass-card p-4 rounded-3xl animate-up relative">
                            <div className="flex justify-between items-start mb-1">
                                <input className="w-full text-lg font-black text-blue-800 bg-transparent outline-none" value={customer} onChange={(e) => setCustomer(e.target.value)} placeholder="Tên khách..."/>
                                <button onClick={() => setShowCustomerPicker(true)} className="ml-2 text-blue-500 p-1"><Icons.Search /></button>
                            </div>
                            <input className="w-full text-[11px] italic text-blue-400 bg-transparent outline-none" value={customerNote} onChange={(e) => setCustomerNote(e.target.value)} placeholder="Ghi chú khách hàng..."/>
                        </div>

                        {/* Form nhập hàng */}
                        <div className="glass-card p-5 rounded-[2rem] space-y-4 animate-up">
                            <div className="relative">
                                <input className="w-full p-4 bg-blue-50 rounded-2xl text-sm font-bold outline-none text-blue-900 pr-12" placeholder="Tên sản phẩm..." value={form.name} onChange={(e) => setForm({...form, name: e.target.value})}/>
                                <button onClick={() => setShowProductPicker(true)} className="absolute right-4 top-1/2 -translate-y-1/2 text-blue-400"><Icons.Search /></button>
                            </div>
                            
                            <div className="flex gap-2">
                                <input type="number" className="flex-1 p-4 bg-blue-50 rounded-2xl font-black text-blue-700 outline-none text-lg" placeholder="Giá" value={form.price} onChange={(e) => setForm({...form, price: e.target.value})}/>
                                <input type="number" className="w-24 p-4 bg-blue-50 rounded-2xl text-center font-black text-blue-700 outline-none text-lg" placeholder="SL" value={form.qty} onChange={(e) => setForm({...form, qty: e.target.value})}/>
                            </div>
                            
                            <input className="w-full p-3 bg-blue-50/50 rounded-xl text-[10px] italic outline-none text-blue-400" placeholder="Ghi chú / % giảm giá..." value={form.promo} onChange={(e) => setForm({...form, promo: e.target.value})}/>

                            <button onClick={addItem} className="w-full btn-blue text-white py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3 font-bold text-xs uppercase">
                                <Icons.Plus /> Thêm vào đơn
                            </button>
                        </div>

                        {/* Danh sách items */}
                        <div className="space-y-3 pb-40">
                            {items.map(item => (
                                <div key={item.id} className="glass-card p-4 rounded-2xl flex justify-between items-center border-l-4 border-blue-500 animate-up">
                                    <div className="flex-1">
                                        <div className="font-bold text-blue-900 text-sm uppercase">{item.name}</div>
                                        <div className="text-[10px] text-blue-400 font-bold">{item.qty} x {item.originalPrice.toLocaleString()}đ {item.discountText && <span className="text-red-500 ml-1">{item.discountText}</span>}</div>
                                    </div>
                                    <div className="text-right flex items-center gap-4">
                                        <div className="font-black text-blue-800">{(item.qty * item.price).toLocaleString()}</div>
                                        <button onClick={() => setItems(items.filter(i => i.id !== item.id))} className="text-blue-200"><Icons.Trash /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Footer thanh toán */}
                    <div className="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl px-6 pt-5 pb-8 border-t rounded-t-[2.5rem] shadow-2xl">
                        <div className="flex justify-between items-end mb-4">
                            <span className="text-[10px] font-black text-blue-300 uppercase tracking-widest">Thành tiền</span>
                            <span className="text-3xl font-black text-blue-600 italic">{total.toLocaleString()}đ</span>
                        </div>
                        <button onClick={handleDownload} className="w-full btn-blue text-white font-black py-4 rounded-2xl uppercase tracking-widest text-xs shadow-lg">Tải xuống hóa đơn</button>
                    </div>

                    {/* Modal Chọn Sản Phẩm */}
                    {showProductPicker && (
                        <div className="fixed inset-0 z-[150] bg-blue-900/40 backdrop-blur-sm flex items-end">
                            <div className="bg-white w-full h-[70vh] rounded-t-[3rem] p-6 flex flex-col animate-up">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-black text-blue-700 uppercase italic">Chọn Sản Phẩm</h3>
                                    <button onClick={() => setShowProductPicker(false)} className="text-gray-400 text-2xl">&times;</button>
                                </div>
                                <input className="w-full p-4 bg-blue-50 rounded-2xl mb-4 outline-none font-bold text-blue-900" placeholder="Tìm tên sản phẩm..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} autoFocus/>
                                <div className="flex-1 overflow-y-auto space-y-2 no-scrollbar">
                                    {filteredProducts.map((p, idx) => (
                                        <div key={idx} onClick={() => selectProduct(p)} className="p-4 bg-white border border-blue-50 rounded-2xl flex justify-between items-center active:bg-blue-50">
                                            <span className="font-bold text-blue-800 uppercase text-xs">{p.name}</span>
                                            <span className="font-black text-blue-600">{Number(p.price).toLocaleString()}đ</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Chọn Khách Hàng */}
                    {showCustomerPicker && (
                        <div className="fixed inset-0 z-[150] bg-blue-900/40 backdrop-blur-sm flex items-end">
                            <div className="bg-white w-full h-[70vh] rounded-t-[3rem] p-6 flex flex-col animate-up">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-black text-blue-700 uppercase italic">Chọn Khách Hàng</h3>
                                    <button onClick={() => setShowCustomerPicker(false)} className="text-gray-400 text-2xl">&times;</button>
                                </div>
                                <input className="w-full p-4 bg-blue-50 rounded-2xl mb-4 outline-none font-bold text-blue-900" placeholder="Tìm tên khách..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} autoFocus/>
                                <div className="flex-1 overflow-y-auto space-y-2 no-scrollbar">
                                    {filteredCustomers.map((c, idx) => (
                                        <div key={idx} onClick={() => selectCustomer(c)} className="p-4 bg-white border border-blue-50 rounded-2xl active:bg-blue-50">
                                            <div className="font-black text-blue-800 uppercase text-xs">{c.name}</div>
                                            <div className="text-[10px] text-blue-400 italic">{c.note}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[120] bg-blue-900/40 backdrop-blur-sm flex items-end">
                            <div className="bg-white w-full p-8 rounded-t-[3rem] animate-up shadow-2xl">
                                <h3 className="font-black text-blue-700 uppercase italic mb-4">Kết nối Google Sheet</h3>
                                <textarea className="w-full p-4 bg-blue-50 rounded-2xl text-[10px] h-32 outline-none border border-blue-100" value={sheetUrl} onChange={(e) => { setSheetUrl(e.target.value); localStorage.setItem('POS_SHEET_NL', e.target.value); }} placeholder="Dán link App Script (chứa dữ liệu SanPham & KhachHang)..."/>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={fetchData} className="flex-1 bg-blue-100 text-blue-600 font-bold py-4 rounded-2xl text-[10px]">TẢI LẠI DATA</button>
                                    <button onClick={() => setShowSettings(false)} className="flex-[2] btn-blue text-white font-black py-4 rounded-2xl text-[10px]">ĐÓNG</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Hóa đơn ẩn để chụp ảnh */}
                    <div className="fixed -left-[5000px]">
                        <div ref={receiptRef} className="w-[600px] bg-white p-12 text-blue-900 font-sans">
                            <h1 className="text-4xl font-black text-center mb-2 uppercase italic">NGỌC LAN</h1>
                            <p className="text-center text-sm font-bold opacity-40 mb-10 tracking-[0.4em]">BÌNH THUẬN</p>
                            <div className="border-y-2 border-blue-500 py-6 mb-8">
                                <div className="text-xs font-bold opacity-50 uppercase mb-1">Khách hàng</div>
                                <div className="text-3xl font-black uppercase mb-1">{customer}</div>
                                <div className="text-sm font-bold italic opacity-60">{customerNote}</div>
                            </div>
                            <div className="space-y-6 mb-10">
                                {items.map(i => (
                                    <div key={i.id} className="flex justify-between items-end border-b border-blue-50 pb-4">
                                        <div className="flex-1">
                                            <div className="font-black text-xl uppercase mb-1">{i.name}</div>
                                            <div className="text-sm font-bold opacity-50">{i.qty} x {i.originalPrice.toLocaleString()}đ {i.discountText && <span className="text-blue-600 ml-1">{i.discountText}</span>}</div>
                                        </div>
                                        <div className="text-2xl font-black">{(i.qty * i.price).toLocaleString()}đ</div>
                                    </div>
                                ))}
                            </div>
                            <div className="bg-blue-600 text-white p-8 rounded-3xl flex justify-between items-center">
                                <span className="text-sm font-black uppercase opacity-60">Tổng cộng</span>
                                <span className="text-5xl font-black italic">{total.toLocaleString()}đ</span>
                            </div>
                            <div className="text-center mt-12 opacity-30 text-[10px] font-bold uppercase tracking-widest italic italic">Cảm ơn quý khách đã tin tưởng Ngọc Lan</div>
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
