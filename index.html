<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KiotViet POS</title>

<!-- LIB -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
:root{--green:#06a36b}
body{margin:0;font-family:system-ui;background:#f4f6f8}
.app{max-width:420px;margin:auto;min-height:100vh;padding-bottom:110px}
header{background:var(--green);color:#fff;padding:12px;text-align:center;font-weight:700;position:sticky;top:0}
.card{background:#fff;margin:12px;border-radius:12px;padding:12px}
.btn{background:var(--green);color:#fff;border:none;width:100%;padding:14px;border-radius:12px;font-size:16px;font-weight:700}
.list{display:flex;flex-direction:column;gap:8px}
.item{display:flex;justify-content:space-between;padding:10px;border:1px solid #eee;border-radius:10px}
.fixed{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);width:100%;max-width:420px;padding:0 12px}
.modal{position:fixed;inset:0;background:#fff;z-index:100;display:none;flex-direction:column}
.modal header{background:var(--green);color:#fff;padding:12px;display:flex;justify-content:space-between}
.search{padding:12px}
.search input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd}
.product{padding:12px;border-bottom:1px solid #eee}
.product b{display:block}
#scanner{height:220px}
</style>
</head>

<body>
<div class="app">

<header>T·∫†O ƒê∆†N H√ÄNG</header>

<div class="card">
<b>S·∫£n ph·∫©m</b>
<div id="orderList" class="list"></div>
</div>

<div class="card">
<b>T·ªïng ti·ªÅn: <span id="total">0 ‚Ç´</span></b>
</div>

<div class="fixed">
<button class="btn" onclick="openCatalog()">‚ûï Th√™m s·∫£n ph·∫©m</button>
<div style="height:8px"></div>
<button class="btn" onclick="exportBill()">üßæ Xu·∫•t h√≥a ƒë∆°n (·∫¢nh)</button>
</div>

</div>

<!-- MODAL CATALOG -->
<div class="modal" id="catalog">
<header>
  <span>Ch·ªçn s·∫£n ph·∫©m</span>
  <button onclick="closeCatalog()">‚úï</button>
</header>

<div class="search">
<input placeholder="T√¨m t√™n / SKU" oninput="searchProduct(this.value)">
</div>

<div id="scanner"></div>

<div id="catalogList" style="flex:1;overflow:auto"></div>
</div>

<script>
/* ===== DATA ===== */
const products=[
 {id:1,name:"Thi√™n M√¥n B·ªï Ph·∫ø",price:85000,sku:"TM01"},
 {id:2,name:"Calci T·∫£o Bi·ªÉn",price:120000,sku:"CTB02"},
 {id:3,name:"Siro Ho B√°ch B·ªô",price:65000,sku:"SH03"}
];
let order=[];

/* ===== OPEN / CLOSE ===== */
function openCatalog(){
 document.getElementById('catalog').style.display='flex';
 renderCatalog(products);
 startScanner();
}
function closeCatalog(){
 document.getElementById('catalog').style.display='none';
 stopScanner();
}

/* ===== SEARCH ===== */
function searchProduct(k){
 k=k.toLowerCase();
 renderCatalog(products.filter(p=>p.name.toLowerCase().includes(k)||p.sku.toLowerCase().includes(k)));
}

/* ===== RENDER ===== */
function renderCatalog(list){
 const el=document.getElementById('catalogList');
 el.innerHTML='';
 list.forEach(p=>{
  const d=document.createElement('div');
  d.className='product';
  d.innerHTML=`<b>${p.name}</b>SKU: ${p.sku}<br>${format(p.price)}`;
  d.onclick=()=>addProduct(p);
  el.appendChild(d);
 });
}

/* ===== ORDER ===== */
function addProduct(p){
 const qty=+prompt("S·ªë l∆∞·ª£ng",1);
 if(!qty) return;
 const found=order.find(i=>i.id===p.id);
 if(found) found.qty+=qty;
 else order.push({...p,qty});
 closeCatalog();
 renderOrder();
}

function renderOrder(){
 const el=document.getElementById('orderList');
 el.innerHTML='';
 let sum=0;
 order.forEach(p=>{
  sum+=p.qty*p.price;
  el.innerHTML+=`<div class="item"><div>${p.name} x ${p.qty}</div><b>${format(p.qty*p.price)}</b></div>`;
 });
 document.getElementById('total').innerText=format(sum);
}

/* ===== BILL IMAGE ===== */
function exportBill(){
 const bill=document.createElement('div');
 bill.style.width='300px';
 bill.style.background='#fff';
 bill.style.padding='16px';
 bill.innerHTML='<h3 style="text-align:center">H√ìA ƒê∆†N</h3>';
 let sum=0;
 order.forEach(p=>{
  sum+=p.qty*p.price;
  bill.innerHTML+=`${p.name} x ${p.qty} = ${format(p.qty*p.price)}<br>`;
 });
 bill.innerHTML+=`<hr><b>T·ªïng: ${format(sum)}</b>`;
 document.body.appendChild(bill);

 html2canvas(bill).then(c=>{
  const a=document.createElement('a');
  a.href=c.toDataURL();
  a.download='hoa-don.png';
  a.click();
  bill.remove();
 });
}

/* ===== BARCODE ===== */
function startScanner(){
 Quagga.init({
  inputStream:{name:"Live",type:"LiveStream",target:document.querySelector('#scanner')},
  decoder:{readers:["code_128_reader","ean_reader"]}
 },err=>{
  if(!err) Quagga.start();
 });
 Quagga.onDetected(data=>{
  const code=data.codeResult.code;
  const found=products.find(p=>p.sku===code);
  if(found){
    addProduct(found);
    Quagga.stop();
  }
 });
}
function stopScanner(){
 try{Quagga.stop()}catch(e){}
}

/* ===== UTIL ===== */
function format(n){return n.toLocaleString('vi-VN')+' ‚Ç´'}
</script>

</body>
</html>
